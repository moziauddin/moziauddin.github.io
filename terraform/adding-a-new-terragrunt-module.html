<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Terraform Tutorials</title>
<link rel="stylesheet" href="css/styles.css">
</head>
<body class="article">
<div id="header">
<h1>Terraform Tutorials</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><a href="../about.html">Home <span class="icon"><i class="fa fa-home"></i></span></a></th>
<th class="tableblock halign-left valign-top"><a href="../index.html">Blog <span class="icon"><i class="fa fa-university"></i></span></a></th>
<th class="tableblock halign-left valign-top"><a href="../contact.html">Contact <span class="icon"><i class="fa fa-phone"></i></span></a></th>
</tr>
</thead>
</table>
<div class="paragraph right text-center">
<p><span class="icon Maroon"><i class="fa fa-snowflake-o fa-5x"></i></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding_a_new_module_in_terrafrom_or_terragrunt">Adding a new Module in Terrafrom or Terragrunt</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_my_setup">My setup</h3>
<div class="paragraph">
<p>We have a few terraform nmodules separated by catgory. For example, all the networking infrastructure on AWS is in vpc, etc. Our folder structure is as below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">terraform
    |--- acm/
    |--- db/
    |--- domain/
    |--- other/
    |--- publicdns/
    |--- simplead/
    |--- terragrunt.hcl
    |--- vpc/
    |--- web/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of the directories under terraform is its own module. I am using terragrunt to simplify plan and apply across multiple modules.You can read about it <a href="https://terragrunt.gruntwork.io/docs/getting-started/quick-start/">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_new_terragrunt_module">Create new terragrunt module</h3>
<div class="paragraph">
<p>I would like to add a new module called <code>graphql_test</code>. All I have to to get started is to create a new directory and change into it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd /terraform
mkdir graphql_test
cd graphql_test</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next thing I wann do is to create the following files.</p>
</div>
<div class="sect3">
<h4 id="_terragent_hcl_file">terragent.hcl file</h4>
<div class="paragraph">
<p>I want to get vpc id from other module, so I can do that by creating a new file called <code>terragrunt.hcl</code> with contents below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">include {
  path = find_in_parent_folders()
}

dependency "vpc" {
  config_path = "../vpc"

inputs = {
  vpc_id = dependency.vpc.outputs.vpc_id
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>include</code> section includes the terragrunt.hcl file in the root of the project so that it can get the remote state configuration defined in the root <code>terragrunt.hcl</code> file in <code>/terraform</code> folder.</p>
</div>
<div class="sect4">
<h5 id="_remote_state_config_s3">Remote state config - s3</h5>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json"># stage/terragrunt.hcl
remote_state {
  backend = "s3"
  generate = {
    path      = "backend.tf"
    if_exists = "overwrite_terragrunt"
  }
  config = {
    bucket = "my-terraform-state"

    key = "${path_relative_to_include()}/terraform.tfstate"
    region         = "us-east-1"
    encrypt        = true
    dynamodb_table = "my-lock-table"
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_locals_tf">locals.tf</h4>
<div class="paragraph">
<p>Create a <code>locals.tf</code> file with below contents to define any variables.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">locals {
  v_aws_service_name = "ecs.amazonaws.com"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use these variables in the other <code>.tf</code> files.</p>
</div>
</div>
<div class="sect3">
<h4 id="_main_tf">main.tf</h4>
<div class="paragraph">
<p>We need to create a resource to check if the module is functional, so I will just create a ECS services to deploy graphql on AWS ECS. I will add the following contents to the <code>main.tf</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json"># Service role allowing AWS to manage resources required for ECS

resource "aws_iam_service_linked_role" "ecs_service" {
  aws_service_name = v_aws_service_name
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are ready to test.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_terraform_init_upgrade">terraform init -upgrade</h3>
<div class="paragraph">
<p>We can start by initiating the new module with command <code>terraform init -upgrade</code></p>
</div>
<div class="sect3">
<h4 id="_output">output</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mo@localhost:/terraform/graphql_test$ terraform init -upgrade

Initializing the backend...

Initializing provider plugins...
- Finding hashicorp/aws versions matching "~&gt; 3.54.0"...
- Finding latest version of hashicorp/archive...
- Installing hashicorp/aws v3.54.0...
- Installed hashicorp/aws v3.54.0 (signed by HashiCorp)
- Installing hashicorp/archive v2.2.0...
- Installed hashicorp/archive v2.2.0 (signed by HashiCorp)

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.

Terraform has been successfully initialized!</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now run <code>terragrunt plan</code> to check the changes this will cause to the infrastructure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mo@localhost:/terraform/graphql_test$ terragrunt plan

Terraform used the selected providers to generate the following execution
plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_iam_service_linked_role.ecs_service will be created
  + resource "aws_iam_service_linked_role" "ecs_service" {
      + arn              = (known after apply)
      + aws_service_name = "ecs.amazonaws.com"
      + create_date      = (known after apply)
      + id               = (known after apply)
      + name             = (known after apply)
      + path             = (known after apply)
      + unique_id        = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.

Note: You didn't use the -out option to save this plan, so Terraform can't
guarantee to take exactly these actions if you run "terraform apply" now.</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is how simple it is to create a new terraform modute and run plan on it using terragrunt.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-04-18 22:57:47 UTC
</div>
</div>
</body>
</html>
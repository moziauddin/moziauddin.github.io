<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<title>Terraform Tutorials</title>
<link rel="stylesheet" href="css/styles.css">
</head>
<body class="article">
<div id="header">
<h1>Terraform Tutorials</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><a href="../about.html">Home <span class="icon"><i class="fa fa-home"></i></span></a></th>
<th class="tableblock halign-left valign-top"><a href="../index.html">Blog <span class="icon"><i class="fa fa-university"></i></span></a></th>
<th class="tableblock halign-left valign-top"><a href="../contact.html">Contact <span class="icon"><i class="fa fa-phone"></i></span></a></th>
</tr>
</thead>
</table>
<div class="paragraph right text-center">
<p><span class="icon Maroon"><i class="fa fa-snowflake-o fa-5x"></i></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_issue">The Issue</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_how_to_reproduce_the_issue">How to reproduce the issue</h3>
<div class="sect3">
<h4 id="_terragrunt_init">terragrunt init</h4>
<div class="paragraph">
<p>When you setup a new terraform module and run <code>terraform init</code>, a couple of files are created.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>provider.tf</code></p>
</li>
<li>
<p><code>.terraform.lock.hcl</code></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mo@localhost:/terraform/hasura$ terraform init

Initializing the backend...

Initializing provider plugins...
- Finding latest version of hashicorp/aws...
- Installing hashicorp/aws v3.65.0...
- Installed hashicorp/aws v3.65.0 (signed by HashiCorp)

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.

Terraform has been successfully initialized!</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_terragrunt_plan">terragrunt plan</h4>
<div class="paragraph">
<p>When you run <code>terragrunt plan</code> it leads to the below error.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mo@localhost:/terraform/hasura$ terraform plan
Initializing the backend...

Successfully configured the backend "s3"! Terraform will automatically
use this backend unless the backend configuration changes.

│ Error: Failed to query available provider packages
│
│ Could not retrieve the list of available versions for provider
│ hashicorp/aws: locked provider registry.terraform.io/hashicorp/aws 3.65.0
│ does not match configured version constraint ~&gt; 3.54.0; must use terraform
│ init -upgrade to allow selection of new versions</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_investigation">Investigation</h3>
<div class="paragraph">
<p>It seems to be complaining about version mis-match from <code>3.54.0</code> with <code>3.65.0</code>. So, I decided to investigate looking for those version numbers.</p>
</div>
<div class="sect3">
<h4 id="_provider_tf_file">provider.tf file</h4>
<div class="paragraph">
<p>provider.tf has the below configuration in it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">terraform {
  required_providers {
    archive = {
      source = "hashicorp/archive"
    }
    aws = {
      version = "~&gt; 3.54.0"
    }
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_terraform_lock_hcl_file">.terraform.lock.hcl file</h4>
<div class="paragraph">
<p><code>.terrform.lock.hcl</code> file has the below configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">provider "registry.terraform.io/hashicorp/aws" {
  version     = "3.65.0"
  constraints = "~&gt; 3.65.0"
  ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solution">Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I removed the <code>.terrform.lock.hcl</code> file and ran the below command.</p>
</div>
<div class="paragraph">
<p><code>terraform init -upgrade</code></p>
</div>
<div class="paragraph">
<p>That re-created the <code>.terraform.lock.hcl</code> file again with correct version and <code>terraform plan</code> was successful as shown below.</p>
</div>
<div class="sect2">
<h3 id="_terraform_lock_hcl_file_2">.terraform.lock.hcl file</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">provider "registry.terraform.io/hashicorp/aws" {
  version     = "3.54.0"
  constraints = "~&gt; 3.54.0"
  hashes = [
    ...
  ]
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_terraform_init_upgrade_output">terraform init -upgrade output</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mo@localhost:/terraform/hasura$ terraform plan
Initializing the backend...

Initializing provider plugins...
- Finding hashicorp/aws versions matching "~&gt; 3.54.0"...
- Finding latest version of hashicorp/archive...
- Installing hashicorp/aws v3.54.0...
- Installed hashicorp/aws v3.54.0 (signed by HashiCorp)
- Installing hashicorp/archive v2.2.0...
- Installed hashicorp/archive v2.2.0 (signed by HashiCorp)

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file in your version control repository
so that Terraform can guarantee to make the same selections by default when
you run "terraform init" in the future.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_terraform_plan_output">terraform plan output</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mo@localhost:/terraform/hasura$ terraform plan

Terraform used the selected providers to generate the following execution
plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_iam_service_linked_role.ecs_service will be created
  + resource "aws_iam_service_linked_role" "ecs_service" {
      + arn              = (known after apply)
      + aws_service_name = "ecs.amazonaws.com"
      + create_date      = (known after apply)
      + id               = (known after apply)
      + name             = (known after apply)
      + path             = (known after apply)
      + unique_id        = (known after apply)
    }

Plan: 1 to add, 0 to change, 0 to destroy.</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you come across this issue, you can easily fix it by following this simple guide</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-04-19 03:40:17 UTC
</div>
</div>
</body>
</html>